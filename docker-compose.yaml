services:
  # zookeeper:
  #   image: confluentinc/cp-zookeeper:7.7.7
  #   container_name: zookeeper
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #     ZOOKEEPER_TICK_TIME: 2000
  #   ports:
  #     - "2181:2181"

  kafka1:
    image: confluentinc/cp-kafka:8.0.3
    container_name: kafka1
    ports:
      - "9094:9094"
    environment:
      CLUSTER_ID: kafka
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_BROKER_ID: 1
      KAFKA_NODE_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:9093,2@kafka2:9093,3@kafka3:9093

  kafka2:
    image: confluentinc/cp-kafka:8.0.3
    container_name: kafka2
    ports:
      - "9095:9095"
    environment:
      CLUSTER_ID: kafka
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_BROKER_ID: 2
      KAFKA_NODE_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9095,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:9095
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:9093,2@kafka2:9093,3@kafka3:9093

  kafka3:
    image: confluentinc/cp-kafka:8.0.3
    container_name: kafka3
    ports:
      - "9096:9096"
    environment:
      CLUSTER_ID: kafka
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_BROKER_ID: 3
      KAFKA_NODE_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9096,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:9096
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:9093,2@kafka2:9093,3@kafka3:9093

  kafka-rest:
    image: confluentinc/cp-kafka-rest:8.1.1
    container_name: kafka-rest
    depends_on:
      - kafka1
      - kafka2
      - kafka3
    ports:
      - "8082:8082"
    environment:
      KAFKA_REST_LISTENERS: http://0.0.0.0:8082
      KAFKA_REST_BOOTSTRAP_SERVERS: PLAINTEXT://kafka1:9094,PLAINTEXT://kafka2:9095,PLAINTEXT://kafka3:9096
      KAFKA_REST_HOST_NAME: kafka-rest
      KAFKA_REST_AUTHENTICATION_METHOD: NONE

  confluent-cli:
    image: confluentinc/confluent-cli:4.48.0
    container_name: confluent-cli
    depends_on:
      - kafka1
      - kafka2
      - kafka3
    entrypoint: ["tail", "-f", "/dev/null"]
    environment:
      CONFLUENT_REST_URL: http://kafka-rest:8082

  apicurio-registry:
      image: apicurio/apicurio-registry:3.1.6
      container_name: apicurio-registry
      depends_on:
        - kafka1
        - kafka2
        - kafka3
      ports:
        - "8080:8080"
      environment:
        REGISTRY_STORAGE_TYPE: kafka
        REGISTRY_KAFKA_BOOTSTRAP_SERVERS: kafka1:9094,kafka2:9095,kafka3:9096
        REGISTRY_KAFKA_TOPIC: _apicurio-registry
        REGISTRY_LOG_LEVEL: INFO

  mysql:
    image: mysql:8.0.44-debian
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: default
      MYSQL_USER: mysql
      MYSQL_PASSWORD: mysql
    volumes:
      - ./initdb:/docker-entrypoint-initdb.d
      - mysql-data:/var/lib/mysql
    command: >
      --server-id=123456
      --log-bin=mysql-bin
      --binlog-format=ROW
      --binlog-row-image=FULL
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --max-allowed-packet=512M

  connect:
    image: debezium/connect:3.0.0.Final
    container_name: connect
    depends_on:
      - kafka1
      - kafka2
      - kafka3
      - mysql
    ports:
      - "8083:8083"
    environment:
      BOOTSTRAP_SERVERS: kafka1:9094,kafka2:9095,kafka3:9096
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: my_connect_configs
      OFFSET_STORAGE_TOPIC: my_connect_offsets
      STATUS_STORAGE_TOPIC: my_connect_statuses
      # Converters (JSON is easiest for testing, Avro is better for Prod)
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter

  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.2
    container_name: kafka-ui
    depends_on:
      - kafka1
      - kafka2
      - kafka3
      - connect
      - apicurio-registry
    ports:
      - "8084:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka1:9094,kafka2:9095,kafka3:9096
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://apicurio-registry:8080/apis/ccompat/v7
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: debezium-connect
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://connect:8083

  flink-jm:
    image: flink:scala_2.12-java21
    container_name: flink-jm
    ports:
      - "8081:8081" # Flink Web Dashboard
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jm

  flink-tm:
    image: flink:scala_2.12-java21
    container_name: flink-tm
    depends_on:
      - flink-jm
    command: taskmanager
    scale: 1 # Increase this if you need more parallelism
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jm
        taskmanager.numberOfTaskSlots: 2

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"

  iceberg-rest:
    image: apache/iceberg-rest-fixture:1.10.1
    container_name: iceberg-rest
    ports:
      - "8181:8181"
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: password
      AWS_REGION: us-east-1
      CATALOG_WAREHOUSE: s3://iceberg/
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO
      CATALOG_S3_ENDPOINT: http://minio:9000
      CATALOG_S3_PATH__STYLE__ACCESS: true

  trino:
    image: trinodb/trino:479
    container_name: trino
    ports:
      - "8086:8080"
    volumes:
      - ./trino/etc:/etc/trino
    depends_on:
      - iceberg-rest
      - minio

  postgres:
    image: postgres:18-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: default
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7.4-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --requirepass "redis"
      --appendonly yes
      --aof-use-rdb-preamble yes
      --save 60 1
    volumes:
      - redis-data:/data

  # 1. Kratos Migration
  kratos-migrate:
    image: oryd/kratos:v25.4.0
    container_name: kratos-migrate
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/kratos_db?sslmode=disable
    command: migrate sql -e --yes
    restart: on-failure

  # 2. Hydra Migration
  hydra-migrate:
    image: oryd/hydra:v25.4.0
    container_name: hydra-migrate
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/hydra_db?sslmode=disable
    command: migrate sql -e --yes
    restart: on-failure

  # 3. Keto Migration
  keto-migrate:
    image: oryd/keto:v25.4.0
    container_name: keto-migrate
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/keto_db?sslmode=disable
    volumes:
      - ./keto:/etc/config/keto
    command: migrate up -c /etc/config/keto/keto.yml --yes
    restart: on-failure

  kratos:
    image: oryd/kratos:v25.4.0
    container_name: kratos
    ports:
      - "4433:4433" # Public API
      - "4434:4434" # Admin API
    volumes:
      - ./kratos:/etc/config/kratos
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/kratos_db?sslmode=disable
    command: serve -c /etc/config/kratos/kratos.yml --dev
    env_file:
      - .env
    depends_on:
      - kratos-migrate

  # --- ORY HYDRA (OAuth2) ---
  hydra:
    image: oryd/hydra:v25.4.0
    container_name: hydra
    ports:
      - "4444:4444" # Public API
      - "4445:4445" # Admin API
      - "4446:4446" # Admin API
    volumes:
      - ./hydra:/etc/config/hydra
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/hydra_db?sslmode=disable
    command: serve all -c /etc/config/hydra/hydra.yml --dev
    depends_on:
      - hydra-migrate

  # --- ORY KETO (Permissions) ---
  keto:
    image: oryd/keto:v25.4.0
    container_name: keto
    ports:
      - "4466:4466" # Read API
      - "4467:4467" # Write API
    volumes:
      - ./keto:/etc/config/keto
    environment:
      - DSN=postgres://postgres:postgres@postgres:5432/keto_db?sslmode=disable
    command: serve -c /etc/config/keto/keto.yml
    depends_on:
      - keto-migrate

  # --- ORY OATHKEEPER (Proxy) ---
  oathkeeper:
    image: oryd/oathkeeper:v25.4.0
    container_name: oathkeeper
    ports:
      - "4455:4455" # Proxy Port
      - "4456:4456" # API Port
    volumes:
      - ./oathkeeper:/etc/config/oathkeeper
    command: serve proxy -c /etc/config/oathkeeper/oathkeeper.yml

  kratos-ui:
    image: oryd/kratos-selfservice-ui-node:v25.4.0
    container_name: kratos-ui
    ports:
      - "3000:3000"
    environment:
      - KRATOS_PUBLIC_URL=http://kratos:4433
      - KRATOS_BROWSER_URL=http://localhost:4433
      - KRATOS_ADMIN_URL=http://localhost:4434
      - COOKIE_SECRET=cookie_secret  # At least 8 chars
      - CSRF_COOKIE_SECRET=csrf_cookie_secret # At least 8 chars
      - CSRF_COOKIE_NAME=ory_kratos_ui_csrf
      # --- CRITICAL FOR LOCALHOST (HTTP) ---
      - DANGEROUSLY_DISABLE_SECURE_CSRF_COOKIES=true

  hydra-ui:
    image: oryd/hydra-login-consent-node:v25.4.0
    container_name: hydra-ui
    ports:
      - "3001:3000"
    environment:
      - HYDRA_ADMIN_URL=http://hydra:4445
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - MOCK_TLS_TERMINATION=y

volumes:
  mysql-data:
  minio-data:
  postgres-data:
  redis-data:
